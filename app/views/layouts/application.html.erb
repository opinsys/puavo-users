<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
       "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
  <title>
    <% if not @school.nil? %>
      <%= @school.displayName %>
    <% elsif session.has_key?(:organisation) %>
      <%= session[:organisation].name %>
    <% else %>
        Puavo Users
    <% end %>
  </title>

  <%= stylesheet_link_tag "breathe/print", :media => 'print' %>
  <%= stylesheet_link_tag "application" %>

  <style id="menuHandling" media="screen" rel="stylesheet" type="text/css" >
    <%#
    CSS for opening menus without Javascript on mouse hover. This should not
    contain anything else. Since for touch devices this element will be
    overridden.
    %>
    .tools .tool:hover ul {
      display: block;
    }
    #top-menu li:hover ul,
    #nav1 ul li:hover ul {
      display: block;
    }

  </style>

  <% search_urls = { "users-search" => "#{ rack_mount_point }search?words=" } %>
  <% if Puavo::DEVICE_CONFIG then search_urls[ "devices-search"] = "/devices/search?words=" end %>
  <%= javascript_tag "window.SEARCH_URLS = { " + search_urls.map{ |key, value| "'#{key}': '#{value}'" }.join(", ") + " };" %>

  <%= javascript_include_tag "application" %>
  <%= yield :javascript %>

  <meta name="csrf-token" content="<%= form_authenticity_token %>" />
  <meta name="csrf-param" content="authenticity_token" />
</head>
<body>
<div class="topNavContainer">
  <div class="topNavContentContainer">
  <ul id="top-menu">
      <% if current_user %>
        <% if current_user.organisation_owner? %>
        <li class="organisation-menu-button">
           <span><%= session[:organisation].name %></span>
           <ul id="help" class="organisation-menu">
             <li class="top-menu-item"><%= link_to t('.about'),  organisation_path %></li>
             <li class="top-menu-item"><%= link_to t('.external_services'),  external_services_path %></li>
	     <% if Puavo::OAUTH_CONFIG %>
             <li class="top-menu-item"><%= link_to t('.oauth_clients'), oauth_clients_path %></li>
	     <% end %>
              <% if Puavo::DEVICE_CONFIG %>
               <li class="top-menu-item"><%= link_to t('.printers'), "/devices/printers" %></li>
               <li class="top-menu-item"><%= link_to t('.servers'), "/devices/servers" %></li>
            <% end %>
           </ul>
        </li>
        <% else %>
        <li><span class="sub"><%= session[:organisation].name %></span></li>
        <% end %>
        <li class="school-menu-button">

          <span><%= t('.schools') %></span>
          <ul class="school-menu">

            <% school_list.each do |school| %>
              <li class="top-menu-item<% if school_list.last == school %> last<% end %>">
                <%= link_to school.displayName,  school_path(school) %>
              </li>
            <% end %>

            <% if current_user.organisation_owner? %>
            <li class="add-new-school">
              <%= link_to t('link.new_school'), new_school_path %>
            </li>
			<% end %>
          </ul>
        </li>
        <li>
              <%= text_field_tag( "search",
                                nil,
                                :id => "search",
                                :size => 30,
                                :placeholder => t('.search_placeholder') ) %>
              </li>
        </ul> <!-- top-menu -->
        <ul id="top-menu-right" class="menu">
            <li><span><%= t('.logged_in_as') %>:</span></li>
                <li><a href="#"><%= current_user.displayName %></a></li>
                <li><%= link_to t('.logout'), logout_path, :method => :delete %></li>
        </ul>
     <% end %>
   </div>
</div><!-- topNavContainer -->
<div id="container" class="container">
<div class="container_wrap">
    <% if session[:organisation] %>
    <% if @school && !@school.id.nil? && controller_name != 'password' %>
    <h1><%= @school.displayName %></h1>

    <div id="navbar_first_level">
      <div id="nav1">
        <ul>
          <li class="<%= controller_name.match(/schools/) \
                     ? "page_item current_page_item" \
                                                    : "page_item" %>">
            <%= link_to school_path(@school) do %>
            <span><%= t('.school') %></span>
            <% end %>
          </li>
          <li class="<%= controller_name.match(/users|groups|roles|import/) ? "page_item current_page_item" : "page_item" %>">
            <%= link_to users_path(@school) do %>
            <span><%= t('.users') %></span>
            <% end %>
          </li>
          <li class="<%= controller_name.match(/devices/) ? "page_item current_page_item" : "page_item" %>">
            <a href="/devices/<%= @school.id%>/devices"><span><%= t('.devices') %></span></a>
          </li>
          <% if @oauth_applications %>
          <% @oauth_applications.each do |app| %>
          <li class="page_item"><a href="<%= app.url %>" title="<%= app.name %>"><span><%= app.name %></span></a></li>
          <% end %>
          <% end %>
        </ul>

      </div><!-- nav1 -->
    </div><!-- navbar_first_level -->

    <div id="navbar_second_level">&nbsp;
      <%=
        # Display second level menu partial if the current view has one
        begin
          render :partial => "menu"
        rescue ActionView::MissingTemplate
        end
       %>
    </div><!-- navbar_second_level -->

    <% end %>
    <% end %>

    <hr class="space" />
  <div class="wrap">
  <div class="maincontent">
         <% if message_keys = flash.keys.select { |key| [:error, :notice, :success, :alert].include?(key) } %>
      <% message_keys.each do |key| %>
      <p class="message_<%= key %>">
        <%= flash[key] %>
      </p>
       <% end %>
       <% end %>

      <% if current_user %>
        <div class="tools">
          <%= yield :right %>
        </div>
      <% end %>
      <%= yield %>
    </div>
    <hr class="space" />
    </div> <!-- wrap -->
  </div> <!-- container_wrap-->
  </div> <!-- container -->
</body>
</html>
